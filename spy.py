import Adafruit_BBIO.GPIO as GPIO

GPIO.setup("P9_15", GPIO.IN)
GPIO.setup("P9_12", GPIO.OUT)
GPIO.output("P9_12", GPIO.HIGH)


from Adafruit_BBIO.SPI import SPI
import time
import sys

#sys.stdout = open('log.log', 'w')

def parse_data(data):
	#print(data)
        address = hex(value[16]).split('x')[1] + hex(value[15]).split('x')[1] + hex(value[14]).split('x')[1] + hex(value[13]).split('x')[1] + hex(value[12]).split('x')[1] + hex(value[11]).split('x')[1]
        #print(address)
        rssi = value[17] - 256
        #print(rssi)
	if rssi > -60:
		if value[28] == 128:
			print("%s, 1, %d") % (address, rssi)
		if value[28] == 129:
			print("%s, 2, %d") % (address, rssi)
		if value[28] == 130:
			print("%s, 3, %d") % (address, rssi)
		if value[28] == 131:
			print("%s, 4, %d") % (address, rssi)


bt = SPI(0, 0)
bt.mode = 1
bt.msh = 1000000

#reset the module

GPIO.output("P9_12", GPIO.LOW)
time.sleep(0.1)
GPIO.output("P9_12", GPIO.HIGH)


# initialize bt module
k=0;
while k<100:
	#print("Sending init message")
	bt.xfer2([ 0x00, 0xFE, 0x2A, 0x01, 0x00, 0xFE, 0x26, 0x02, 
	0x0A,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x00, 0x00, 0x00,0xFA])
	i=0;
	while i<30:
		if GPIO.input("P9_15") != 1:
			value = bt.readbytes(12)
			if value[1] == 0xFE and value[6] == 0 and value[7] == 6:
				#print("Init Success")
				#print(value)
				i=50
				k=100
		time.sleep(0.001)
		i = i + 1;
	k=k+1;
k=0
while k<100:
	#print("Setting Scan Time")
        bt.xfer2([ 0x00, 0xFE, 0x07, 0x01, 0x30, 0xFE, 0x03, 0x02,
        0xFE, 0xFF, 0xC8])
        i=0;
	while i<35:
		if GPIO.input("P9_15") != 1:
	                value = bt.readbytes(12)
        	        if value[1] == 0xFE and value[6] ==127 and value[7] == 6:
                	        #print("Scan time set")
	                        #print(value)
        	                i=50
                	        k=100
                time.sleep(0.001)
                i = i + 1;
        k=k+1;
k=0
while k<100:
        #print("Setting advert filter")
        bt.xfer2([ 0x00, 0xFE, 0x07, 0x01, 0x30, 0xFE, 0x03, 0x23,
        0x00, 0x00, 0xE8])
        i=0;
	while i<35:
		if GPIO.input("P9_15") != 1:
	                value = bt.readbytes(12)
        	        if value[1] == 0xFE and value[6] == 127 and value[7] == 6:
                	        #print("Advert filter set")
	                        #print(value)
        	                i=50
                	        k=100
                time.sleep(0.001)
                i = i + 1;
        k=k+1;
k=0
while k<100:
        #print("Setting scan interval")
        bt.xfer2([ 0x00, 0xFE, 0x07, 0x01, 0x30, 0xFE, 0x03, 0x10,
        0xa0, 0x00, 0x7B])
        i=0;
	while i<35:
		if GPIO.input("P9_15") != 1:
	                value = bt.readbytes(12)
        	        if value[1] == 0xFE and value[6] == 127 and value[7] == 6:
                	        #print("Scan interval set to 100ms")
	                        #print(value)
        	                i=50
                	        k=100
                time.sleep(0.001)
                i = i + 1;
        k=k+1;
k=0
while k<100:
        #print("Setting scan window")
        bt.xfer2([ 0x00, 0xFE, 0x07, 0x01, 0x30, 0xFE, 0x03, 0x11,
        0xa0, 0x00, 0x7A])
        i=0;
	while i<35:
                if GPIO.input("P9_15") != 1:
	                value = bt.readbytes(12)
        	        if value[1] == 0xFE and value[6] == 127 and value[7] == 6:
                	        #print("Scan window set to 100ms")
	                        #print(value)
        	                i=50
                	        k=100
                time.sleep(0.001)
                i = i + 1;
        k=k+1;

k=0
while k<100:
        #print("Setting advert filter")
        bt.xfer2([ 0x00, 0xFE, 0x07, 0x01, 0x30, 0xFE, 0x03, 0x23,
        0x00, 0x00, 0xE8])
        i=0;
	while i<35:
                if GPIO.input("P9_15") != 1:
	                value = bt.readbytes(12)
        	        if value[1] == 0xFE and value[6] == 127 and value[7] == 6:
                	        #print("Advert filter set")
	                        #print(value)
        	                i=50
                	        k=100
                time.sleep(0.001)
                i = i + 1;
        k=k+1;
k=0
while k<100:
        #print("Setting BT scan mode")
        bt.xfer2([ 0x00, 0x00, 0xFE, 0x07, 0x01, 0x04, 0xFE, 0x03,
        0x03, 0x00, 0x00, 0xFC])
        i=0;
	while i<35:
		if GPIO.input("P9_15") != 1:
                	value = bt.readbytes(12)
	                if value[1] == 0xFE and value[6] == 127 and value[7] == 6:
        	                #print("Scanning started")
                	        #print(value)
                       		i=50
	                        k=100
       		time.sleep(0.001)
		i = i + 1;
        k = k + 1;

end_cond = 1
while end_cond:
	if GPIO.input("P9_15") != 1:
		value = bt.readbytes(30)
		if (value[17]-256) > -60 and value[1] == 254 and value[6] == 13 and value[7] == 6 and value[28] > 127 and value[28] < 132 :
			parse_data(value)
			end_cond = 0

#while True:
#	time.sleep(0.1)


