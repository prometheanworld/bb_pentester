import Adafruit_BBIO.GPIO as GPIO

GPIO.setup("P9_15", GPIO.IN)
GPIO.setup("P9_12", GPIO.OUT)
GPIO.output("P9_12", GPIO.HIGH)


from Adafruit_BBIO.SPI import SPI
import time
import sys

def parse_data(data):
	#print(data)
        address = hex(value[16]).split('x')[1] + ":" + hex(value[15]).split('x')[1] + ":" + hex(value[14]).split('x')[1] + ":" +hex(value[13]).split('x')[1] + ":" +hex(value[12]).split('x')[1] + ":" + hex(value[11]).split('x')[1]
        #print(address)
        rssi = value[17] - 256
        #print(rssi)
	if rssi > -70:
		if value[28] == 128:
			print("%s, 1, %d") % (address, rssi)
		if value[28] == 129:
			print("%s, 2, %d") % (address, rssi)
		if value[28] == 130:
			print("%s, 3, %d") % (address, rssi)
		if value[28] == 131:
			print("%s, 4, %d") % (address, rssi)


bt = SPI(0, 0)
bt.mode = 1
bt.msh = 1000000

k=0
while k<100:
        bt.xfer2([ 0x00, 0x00, 0xFE, 0x07, 0x01, 0x04, 0xFE, 0x03,
        0x03, 0x00, 0x00, 0xFC])
        i=0;
	while i<35:
                if GPIO.input("P9_15") != 1:
                        value = bt.readbytes(12)
                        if value[1] == 0xFE and value[6] == 127 and value[7] == 6:
                                print("scanner started")
				i=50
                                k=100
                time.sleep(0.001)
                i = i + 1
	k = k +1


end_cond = 1
while end_cond:
	if GPIO.input("P9_15") != 1:
		value = bt.readbytes(30)
		if (value[17]-256) > -70 and value[1] == 254 and value[6] == 13 and value[7] == 6 and value[28] > 127 and value[28] < 132 :
			parse_data(value)
			end_cond = 0

